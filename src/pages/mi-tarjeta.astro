---
import Layout from '../layouts/Layout.astro';

const pageTitle = 'Mi Tarjeta de Fidelidad | Havanera Nails';
const pageDescription =
  'Tu tarjeta de puntos personal. Acumula 6 puntos y obt茅n 20% de descuento en tu pr贸xima visita.';
---

<Layout title={pageTitle} description={pageDescription} noindex={true}>
  <main class="min-h-screen bg-gradient-to-b from-pink-50 to-white pt-24 pb-24 px-4">
    <div class="max-w-md mx-auto">
      <!-- Header de p谩gina -->
      <header class="text-center mb-6 mt-8">
        <h1 class="text-4xl text-pink-500 font-bold mb-2">Mi Tarjeta</h1>
        <p class="text-gray-600 text-sm">Acumula puntos y obt茅n descuentos</p>
      </header>

      <!-- Tarjeta de Fidelidad -->
      <div
        id="loyalty-card"
        class="bg-white rounded-3xl shadow-xl p-6 sm:p-8 mb-6 relative overflow-hidden"
      >
        <!-- Decoraci贸n de fondo -->
        <div class="absolute -top-10 -right-10 w-32 h-32 bg-pink-100 rounded-full opacity-50"></div>
        <div class="absolute -bottom-10 -left-10 w-24 h-24 bg-pink-200 rounded-full opacity-30">
        </div>

        <!-- Contenido principal -->
        <div class="relative z-10">
          <!-- Encabezado de tarjeta -->
          <div class="flex items-center justify-between mb-6">
            <div>
              <h2 class="text-lg sm:text-xl font-bold text-gray-800">Havanera Nails</h2>
              <p class="text-xs sm:text-sm text-gray-500">Tarjeta de Fidelidad</p>
            </div>
            <div class="text-right">
              <span id="points-display" class="text-4xl sm:text-5xl font-bold text-pink-500">0</span
              >
              <span class="text-lg sm:text-xl text-gray-400">/6</span>
            </div>
          </div>

          <!-- C铆rculos de puntos - MEJORADO: m谩s grandes y t谩ctiles -->
          <div id="points-circles" class="grid grid-cols-6 gap-2 sm:gap-4 mb-6">
            {
              [1, 2, 3, 4, 5, 6].map((num) => (
                <div
                  class="point-circle w-10 h-10 sm:w-14 sm:h-14 rounded-full border-3 border-pink-300 flex items-center justify-center transition-all duration-300 cursor-pointer"
                  data-point={num}
                >
                  <span class="text-pink-400 text-base sm:text-lg font-bold">{num}</span>
                </div>
              ))
            }
          </div>

          <!-- Barra de progreso -->
          <div class="h-3 bg-pink-100 rounded-full overflow-hidden">
            <div
              id="progress-bar"
              class="h-full bg-gradient-to-r from-pink-400 to-pink-500 rounded-full transition-all duration-500"
              style="width: 0%"
            >
            </div>
          </div>

          <!-- Texto de progreso -->
          <p id="progress-text" class="text-center text-sm text-gray-500 mt-3">
            Te faltan <span class="font-bold text-pink-500">6</span> puntos para tu descuento
          </p>
        </div>
      </div>

      <!-- Input de C贸digo -->
      <div id="code-section" class="bg-white rounded-2xl shadow-lg p-5 sm:p-6 mb-6">
        <h3 class="text-base sm:text-lg font-semibold text-gray-800 mb-4 text-center">
          驴Tienes un c贸digo?
        </h3>
        <div class="flex flex-col sm:flex-row gap-3">
          <input
            type="text"
            id="code-input"
            inputmode="numeric"
            pattern="[0-9]*"
            maxlength="4"
            placeholder="0000"
            class="flex-1 text-center text-3xl font-bold tracking-[0.4em] border-2 border-pink-200 rounded-xl py-4 focus:border-pink-500 focus:outline-none focus:ring-2 focus:ring-pink-200 transition-all"
          />
          <button
            id="submit-code"
            class="w-full sm:w-auto bg-gradient-to-r from-pink-500 to-pink-400 text-white px-8 py-4 rounded-xl font-semibold shadow-lg hover:shadow-xl hover:-translate-y-0.5 active:scale-95 transition-all text-lg"
          >
            A帽adir punto
          </button>
        </div>
        <p id="code-message" class="text-center mt-4 text-sm hidden"></p>
      </div>

      <!-- QR Code - CORREGIDO -->
      <div id="qr-section" class="bg-white rounded-2xl shadow-lg p-6 text-center">
        <h3 class="text-base sm:text-lg font-semibold text-gray-800 mb-4">Tu c贸digo QR</h3>
        <p class="text-sm text-gray-500 mb-4">Mu茅stralo al visitar el sal贸n</p>
        <div
          id="qr-container"
          class="inline-flex items-center justify-center bg-white p-4 rounded-2xl border-2 border-pink-100 shadow-inner"
        >
          <!-- Canvas para QR - elemento correcto -->
          <canvas id="qr-canvas" class="w-44 h-44 sm:w-52 sm:h-52"></canvas>
        </div>
        <p id="client-id" class="text-xs text-gray-400 mt-4 font-mono"></p>
      </div>

      <!-- Bot贸n para volver al inicio -->
      <div class="text-center mt-6">
        <a
          href="/"
          class="text-pink-500 hover:text-pink-600 font-medium text-sm inline-flex items-center gap-2"
        >
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
          </svg>
          Volver al inicio
        </a>
      </div>

      <!-- Modal de Descuento -->
      <div
        id="discount-modal"
        class="fixed inset-0 bg-black/80 backdrop-blur-md z-[100] hidden items-center justify-center p-4 transition-opacity duration-300"
      >
        <div
          class="bg-white rounded-3xl p-6 sm:p-8 max-w-sm w-full text-center animate-bounce-in shadow-2xl relative overflow-hidden"
        >
          <!-- Decoraci贸n -->
          <div
            class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-pink-500 via-purple-500 to-pink-500"
          >
          </div>

          <div class="text-7xl mb-4 animate-pulse"></div>
          <h2 class="text-2xl sm:text-3xl font-bold text-gray-800 mb-2">隆Felicidades!</h2>
          <p class="text-gray-600 mb-6">Completaste tu tarjeta de fidelidad</p>

          <div
            class="bg-gradient-to-br from-pink-500 to-purple-600 text-white rounded-2xl p-6 mb-6 shadow-lg transform rotate-1 hover:rotate-0 transition-transform duration-300"
          >
            <p class="text-pink-100 text-sm mb-1 uppercase tracking-wider font-semibold">
              Tu Descuento
            </p>
            <p class="text-5xl font-bold tracking-tight">20% OFF</p>
            <div class="mt-2 text-xs bg-white/20 rounded-full py-1 px-3 inline-block">
              V谩lido para hoy!
            </div>
          </div>

          <p class="text-sm text-gray-500 mb-6 px-4">
            Muestra esta pantalla a la manicurista para aplicar el descuento.
            <br /><span class="text-xs text-pink-500 font-medium"
              >Al cerrar se reiniciar谩n tus puntos.</span
            >
          </p>

          <button
            id="redeem-btn"
            class="w-full bg-gray-900 text-white py-4 rounded-xl font-bold hover:bg-black active:scale-95 transition-all text-lg shadow-xl flex items-center justify-center gap-2 group"
          >
            <span>Usar Descuento y Reiniciar</span>
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="h-5 w-5 group-hover:rotate-180 transition-transform duration-500"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"
              ></path>
            </svg>
          </button>
        </div>
      </div>
    </div>
  </main>
</Layout>

<style>
  /* C铆rculos de puntos - estados */
  .point-circle {
    border-width: 3px;
    min-width: 2.5rem;
    min-height: 2.5rem;
  }

  .point-circle.active {
    background: linear-gradient(135deg, #ec4899, #f472b6);
    border-color: #ec4899;
    box-shadow: 0 4px 12px rgba(236, 72, 153, 0.4);
    transform: scale(1.05);
  }

  .point-circle.active span {
    color: white;
  }

  /* Animaci贸n de entrada del modal */
  @keyframes bounce-in {
    0% {
      transform: scale(0.5);
      opacity: 0;
    }
    50% {
      transform: scale(1.05);
    }
    100% {
      transform: scale(1);
      opacity: 1;
    }
  }

  .animate-bounce-in {
    animation: bounce-in 0.4s ease-out;
  }

  /* Confetti */
  @keyframes confetti {
    0% {
      transform: translateY(0) rotate(0deg);
      opacity: 1;
    }
    100% {
      transform: translateY(-100vh) rotate(720deg);
      opacity: 0;
    }
  }

  .confetti {
    position: fixed;
    border-radius: 2px;
    animation: confetti 3s ease-out forwards;
    z-index: 9999;
  }

  /* Animaci贸n de pulso para nuevo punto */
  @keyframes point-added {
    0%,
    100% {
      transform: scale(1.05);
    }
    50% {
      transform: scale(1.15);
    }
  }

  .point-circle.just-added {
    animation: point-added 0.5s ease-in-out;
  }
</style>

<script>
  import QRCode from 'qrcode';
  import {
    getOrCreateClient,
    validateAndAddPoint,
    hasDiscountAvailable,
    resetLoyaltyCard,
  } from '../scripts/loyalty';

  // Elementos del DOM
  const pointsDisplay = document.getElementById('points-display');
  const pointsCircles = document.querySelectorAll('.point-circle');
  const progressBar = document.getElementById('progress-bar');
  const progressText = document.getElementById('progress-text');
  const codeInput = document.getElementById('code-input') as HTMLInputElement;
  const submitBtn = document.getElementById('submit-code') as HTMLButtonElement;
  const codeMessage = document.getElementById('code-message');
  const qrCanvas = document.getElementById('qr-canvas') as HTMLCanvasElement;
  const clientIdDisplay = document.getElementById('client-id');
  const discountModal = document.getElementById('discount-modal');
  const redeemBtn = document.getElementById('redeem-btn');
  const codeSection = document.getElementById('code-section');

  // Inicializar
  function init() {
    const client = getOrCreateClient();
    updateUI(client.points);
    generateQR(client.clientId);

    if (clientIdDisplay) {
      clientIdDisplay.textContent = `ID: ${client.clientId.slice(0, 8).toUpperCase()}`;
    }

    // Verificar si tiene descuento disponible
    if (hasDiscountAvailable()) {
      showDiscountModal();
    }
  }

  // Actualizar UI con puntos
  function updateUI(points: number, justAdded: boolean = false) {
    if (pointsDisplay) {
      pointsDisplay.textContent = points.toString();
    }

    // Actualizar c铆rculos
    pointsCircles.forEach((circle, index) => {
      if (index < points) {
        circle.classList.add('active');
        // A帽adir animaci贸n al 煤ltimo punto agregado
        if (justAdded && index === points - 1) {
          circle.classList.add('just-added');
          setTimeout(() => circle.classList.remove('just-added'), 500);
        }
      } else {
        circle.classList.remove('active');
      }
    });

    // Actualizar barra de progreso
    if (progressBar) {
      const percentage = (points / 6) * 100;
      progressBar.style.width = `${percentage}%`;
    }

    // Actualizar texto de progreso
    if (progressText) {
      const remaining = 6 - points;
      if (remaining > 0) {
        progressText.innerHTML = `Te ${remaining === 1 ? 'falta' : 'faltan'} <span class="font-bold text-pink-500">${remaining}</span> punto${remaining === 1 ? '' : 's'} para tu descuento`;
      } else {
        progressText.innerHTML =
          '<span class="font-bold text-pink-500"> 隆Descuento desbloqueado!</span>';
      }
    }

    // Si complet贸, cambiar secci贸n de c贸digo
    if (points >= 6 && codeSection) {
      codeSection.innerHTML = `
        <div class="text-center py-6">
          <div class="text-5xl mb-3"></div>
          <p class="text-xl font-semibold text-pink-500 mb-2">隆Tarjeta completada!</p>
          <p class="text-gray-600 mb-4">隆Tienes un 20% de descuento!</p>
          <button 
            id="show-discount"
            class="w-full sm:w-auto bg-gradient-to-r from-pink-500 to-purple-600 text-white px-8 py-3 rounded-xl font-bold shadow-lg transform hover:scale-105 transition-all"
          >
            Ver mi descuento
          </button>
        </div>
      `;
      // Re-asociar evento al nuevo bot贸n
      document.getElementById('show-discount')?.addEventListener('click', showDiscountModal);
    }
  }

  // Generar QR - Usa canvas optimizado
  async function generateQR(clientId: string) {
    if (!qrCanvas) return;

    try {
      await QRCode.toCanvas(qrCanvas, clientId, {
        width: 208,
        margin: 2,
        color: {
          dark: '#ec4899',
          light: '#ffffff',
        },
        errorCorrectionLevel: 'M',
      });
    } catch (error) {
      console.error('Error generando QR:', error);
    }
  }

  // Manejar submit de c贸digo
  function handleSubmit() {
    const code = codeInput?.value.trim();

    if (!code || code.length !== 4) {
      showMessage('Ingresa el c贸digo de 4 d铆gitos', 'error');
      shakeInput();
      return;
    }

    // Llamar a validar
    const result = validateAndAddPoint(code);

    if (result.success) {
      // CASO XITO
      showMessage(result.message, 'success');
      updateUI(result.points || 0, true);

      if (codeInput) codeInput.value = '';

      // Mostrar confetti
      createConfetti();

      // Si complet贸 tarjeta, mostrar modal
      if (result.hasDiscount) {
        setTimeout(() => showDiscountModal(), 1200);
      }
    } else {
      // CASO ERROR O BLOQUEO
      showMessage(result.message, 'error');

      if (result.blocked) {
        // Bloquear UI temporalmente
        blockUI();
      } else {
        shakeInput();
        if (navigator.vibrate) navigator.vibrate(200);
      }
    }
  }

  // Bloquear UI por seguridad
  function blockUI() {
    if (codeInput) {
      codeInput.value = '';
      codeInput.disabled = true;
      codeInput.placeholder = 'BLOQUEADO';
      codeInput.classList.add('bg-gray-100', 'cursor-not-allowed');
    }
    if (submitBtn) {
      submitBtn.disabled = true;
      submitBtn.classList.add('opacity-50', 'cursor-not-allowed');
    }

    // Desbloquear despu茅s de 60s (solo UI, el backend validar谩 igual)
    setTimeout(() => {
      if (codeInput) {
        codeInput.disabled = false;
        codeInput.placeholder = '0000';
        codeInput.classList.remove('bg-gray-100', 'cursor-not-allowed');
        codeInput.focus();
      }
      if (submitBtn) {
        submitBtn.disabled = false;
        submitBtn.classList.remove('opacity-50', 'cursor-not-allowed');
      }
    }, 60000);
  }

  // Animaci贸n de shake para input inv谩lido
  function shakeInput() {
    if (!codeInput) return;
    codeInput.classList.add('animate-shake');
    setTimeout(() => codeInput.classList.remove('animate-shake'), 500);
  }

  // Mostrar mensaje
  function showMessage(text: string, type: 'success' | 'error') {
    if (!codeMessage) return;

    codeMessage.textContent = text;
    codeMessage.classList.remove('hidden', 'text-green-600', 'text-red-500', 'font-bold');

    if (type === 'error') {
      codeMessage.classList.add('text-red-500', 'font-bold');
    } else {
      codeMessage.classList.add('text-green-600');
    }

    // Limpiar timeout anterior si existe
    // (Simple implementation, could be improved with closure)
    setTimeout(() => {
      codeMessage.classList.add('hidden');
    }, 5000);
  }

  // Crear confetti
  function createConfetti() {
    const colors = ['#ec4899', '#f472b6', '#a855f7', '#fbbf24'];
    for (let i = 0; i < 40; i++) {
      const confetti = document.createElement('div');
      confetti.className = 'confetti';
      confetti.style.left = `${Math.random() * 100}vw`;
      confetti.style.background = colors[Math.floor(Math.random() * colors.length)];
      confetti.style.animationDelay = `${Math.random() * 0.5}s`;
      const size = Math.random() * 8 + 6;
      confetti.style.width = `${size}px`;
      confetti.style.height = `${size}px`;
      confetti.style.bottom = '0';
      document.body.appendChild(confetti);
      setTimeout(() => confetti.remove(), 3500);
    }
  }

  // Mostrar modal de descuento
  function showDiscountModal() {
    if (discountModal) {
      discountModal.classList.remove('hidden');
      discountModal.classList.add('flex');
    }
  }

  // Reiniciar tarjeta
  function handleRedeemAndReset() {
    if (!confirm('驴La manicurista ya aplic贸 el descuento? Se reiniciar谩n tus puntos.')) {
      return;
    }

    resetLoyaltyCard();
    location.reload(); // Recargar para estado limpio
  }

  // Event listeners
  submitBtn?.addEventListener('click', handleSubmit);

  codeInput?.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') handleSubmit();
  });

  codeInput?.addEventListener('input', (e) => {
    const input = e.target as HTMLInputElement;
    input.value = input.value.replace(/\D/g, '').slice(0, 4);
  });

  // Listener para bot贸n de canje
  redeemBtn?.addEventListener('click', handleRedeemAndReset);

  // Cerrar modal al hacer click fuera
  discountModal?.addEventListener('click', (e) => {
    if (e.target === discountModal) {
      // Opcional: Permitir cerrar sin canjear?
      // Si cierran sin canjear, sigue lleno.
      discountModal.classList.add('hidden');
      discountModal.classList.remove('flex');
    }
  });

  // Inicializar al cargar
  init();
</script>

<style is:global>
  /* Animaci贸n de shake */
  @keyframes shake {
    0%,
    100% {
      transform: translateX(0);
    }
    20%,
    60% {
      transform: translateX(-8px);
    }
    40%,
    80% {
      transform: translateX(8px);
    }
  }

  .animate-shake {
    animation: shake 0.4s ease-in-out;
  }
</style>
